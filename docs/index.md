# 灘校デジタル委員会認証システム

## 基本的な流れ

1. [Bot を Discord サーバーにインストール](https://nada-auth-v2.nada-digital-committee.workers.dev/invite)
2. `/init` コマンドで認証をリクエストするためのボタンを設置
3. `/config` コマンドで追加の設定（任意）
4. Discord サーバーに新規に参加したユーザーがボタンを押す
5. ユーザーは自分のプロフィール情報を入力
6. ユーザーは学校から配付された Google アカウントでサインインし、アプリに `openid` `email` `profile` へのアクセスを許可
7. アプリは Google アカウントが学内のものであることを確認
8. ロールやニックネームを割り当てる
9. 認証を完了

## 各コマンドの使い方

### `/config`

サーバーの設定を操作します。

#### `/config get [name]?`

| オプション |                         許可される値                          | 既定値 |   説明   |
| :--------: | :-----------------------------------------------------------: | :----: | :------: |
|   `name`   | `"logging-channel"`<br />`"profile-fallback"`<br />`"strict"` | _なし_ | 設定項目 |

設定を表示します。オプション `name` を指定するとその設定項目のみ、省略するとすべての設定項目を表示します。

#### `/config set logging-channel [value]?`

| オプション |    値     | 既定値 |           説明           |
| :--------: | :-------: | :----: | :----------------------: |
|  `value`   | `Channel` | _なし_ | ログを送信するチャンネル |

設定 `logging-channel` を変更します。オプション `value` を指定すると、ログをそのチャンネルに送信するよう設定します。指定しないで実行すると、この設定を削除し、ログを行いません。

#### `/config set profile-fallback [value]?`

| オプション |    値     | 既定値 |          説明          |
| :--------: | :-------: | :----: | :--------------------: |
|  `value`   | `Boolean` | `true` | フォールバックさせるか |

設定 `profile-fallback` を変更します。オプション `value` に `true` を指定すると、厳格モードが無効で、かつユーザーの入力したプロフィール情報が Google アカウントから読み取ったプロフィール情報と合致しなかった場合に、プロフィール情報の参照元をユーザー入力にフォールバックします。`false` を指定すると、プロフィール情報を Google アカウントから読み取った情報から参照します。指定しないで実行すると、この設定を削除し既定値をセットします。

#### `/config set strict [value]?`

| オプション |    値     | 既定値  |           説明           |
| :--------: | :-------: | :-----: | :----------------------: |
|  `value`   | `Boolean` | `false` | 厳格モードを有効にするか |

設定 `strict` を変更します。オプション `value` に `true` を指定すると、厳格モードが有効になります。厳格モードを有効にすると、ユーザーの入力したプロフィール情報が Google アカウントから読み取ったプロフィール情報と合致しなかった場合に、エラーをログに出力して認証を失敗させます。`false` を指定すると厳格モードが無効になり、代わりに警告をログに出力して認証を成功させるようになります。指定しないで実行すると、この設定を削除し既定値をセットします。

#### `/config sheets init`

ロールやニックネームの自動割り当てルールを管理するスプレッドシートを新規に作成し、アプリにアクセス権限を与えます。流れは以下の通りです。

1. コマンドを実行
2. 返却されたボタンを押して、Google アカウントでサインインしてください。このときに使用するアカウントの制限はありません。
3. アプリが「このアプリで使用する Google ドライブ上の特定のファイルのみの参照、編集、作成、削除」の権限を求めていることを確認し、承認してください。アプリがアクセスできるのは、アプリ自身が作成したファイルであるか、あなたがファイル選択ツールで選択したファイルのみであることに注意してください。
4. リダイレクトされたページでボタンを押してファイル選択ツールを開き、スプレッドシートを作成するフォルダを選択してください。フォルダはマイドライブでも共有ドライブでもかまいません。
5. 選択したフォルダにスプレッドシートが作成され、初期化されます。

#### `/config sheets show`

連携しているスプレッドシートのリンクを表示します。

#### `/config sheets unlink [hard]?`

| オプション | 許可される値 | 既定値  |         説明         |
| :--------: | :----------: | :-----: | :------------------: |
|   `hard`   |  `Boolean`   | `false` | ファイルも破棄するか |

スプレッドシートとの連携を解除します。オプション `hard` に `true` を指定すると、アプリ上での紐づけを解除するだけでなく、ファイルも破棄（ごみ箱に移動）します。

### `/init`

#### `/init [channel] [avatar]? [username]?`

| オプション | 許可される値 |                                                                                                 既定値                                                                                                  |              説明              |
| :--------: | :----------: | :-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------: |
| `channel`  |  `Channel`   |                                                                                                 _なし_                                                                                                  | メッセージを送信するチャンネル |
|  `avatar`  | `Attachment` | <img alt="Blob Emoji の子がメガホンを持っている画像。かわいい" src="https://raw.githubusercontent.com/NadaDigitalCommittee/nada-auth-v2/refs/heads/main/public/assets/u1fa84_u1f4e3.webp" width="32" /> | メッセージ送信時のアバター画像 |
| `username` |   `String`   |                                                                                              `"nada-auth"`                                                                                              |  メッセージ送信時のユーザー名  |

認証をリクエストするためのボタンをオプション `channel` で指定したチャンネルに設置します。コマンドを実行するとモーダルが表示されます。モーダルには 2 つのテキストボックスがあります。それぞれのテキストボックスの詳細は次の通りです。

| テキストボックス  |    種類     |  既定値  |           説明           |
| :---------------: | :---------: | :------: | :----------------------: |
|  `button-label`   |   `Short`   | `"認証"` |  ボタンのラベル（任意）  |
| `message-content` | `Paragraph` |  _なし_  | メッセージの本文（任意） |

モーダルを送信すると、コマンドで指定したチャンネルに指定したアバターとユーザー名、内容でメッセージが送信されます。ユーザー名は、[Discord の仕様による制限](https://discord.com/developers/docs/resources/user#usernames-and-nicknames)を受けます。

## スプレッドシートの使い方

初期化されたスプレッドシートは、次のようになっているはずです:

|  種別  | 学年 | 回生 | 組  | 番号 | 姓  | 名  | ロール | ニックネーム |
| :----: | :--: | :--: | :-: | :--: | :-: | :-: | :----: | :----------: |
| &nbsp; |      |      |     |      |     |     |        |              |
|        |      |      |     |      |     |     |        |              |

1 行目はヘッダー、列 A:G の 2 行目以降はマッチさせる属性のパターンを入力する欄、列 H:I の 2 行目以降はマッチしたユーザーに適用するロールおよびニックネームを入力する欄です。以下の節で単に「列 A:G」などというとき、ヘッダーを含みません。

列 A:G の各項目の説明は以下の通りです。最初にアスタリスク `*` がついているものは、ユーザーの種別が `0`（生徒）のときにのみ使用されます。

|      |                                                                                                 |
| :--: | :---------------------------------------------------------------------------------------------- |
| 種別 | ユーザーの種別にマッチします。`0` が生徒、`-1` がそれ以外のユーザー（教職員など）に対応します。 |
| 学年 | \* 学年を表す `1`, `2`, `3`, `4`, `5`, `6` の数字にマッチします。                               |
| 回生 | \* 何回生かを表す数字にマッチします。                                                           |
|  組  | \* 組を表す数字にマッチします。                                                                 |
| 番号 | \* 出席番号を表す数字にマッチします。                                                           |
|  姓  | ユーザーの名（上の名前）にマッチします。                                                        |
|  名  | ユーザーの名（下の名前）にマッチします。                                                        |

「姓」「名」の項目は字形の差異による影響を受けやすいため、他の項目で代用することを検討してください。

### 構文

列 A:H の各セルには、カンマ区切りで複数の値を指定することができます。列 I の各セルには単一の値のみ指定することができます。カンマを入れた場合、値の区切り文字としてではなく、文字カンマとして解釈されます。

どのセルでも、単一の値およびカンマで区切られた値の前後にある空白はすべて無視されます。空の値もまた無視されます。列 A:G のあるセルを空欄または空白のみにすると、その項目はパターンマッチに使われません。列 H:I のあるセルを空欄または空白のみにすると、その項目は適用されません。

セルに構文エラーが検出されるとログに出力され、次のセルまたは行の読み取りが続行されます。

- 列 A:G のセルに構文エラーがある場合、その行の読み取りは終了し、次の行に移ります。エラーがあった行は無視され、パターンマッチに使われません。
- 列 H:I のセルに構文エラーがある場合、そのセルの読み取りは終了し、次のセルに移ります。エラーがあったセルは無視され、適用されません。

ログ出力では、エラーが検出されたセルの位置は A1 記法またはセル A2 を原点とする zero-based な行番号 / 列番号で表されます。セル内のカンマ区切りで列挙された項目のインデックス表記もまた zero-based です。

### ロールの構文

ロール欄には、ロール ID またはその先頭にハイフンマイナス `-` をつけた文字列をカンマ区切りで入力します。ロール ID を入力すると、そのロールを付与できます。先頭にハイフンマイナスがついたロール ID を入力すると、そのロールを削除できます。ユーザーがそのロールを割り当てられていない場合、単に無視されます。

ロール ID の後ろにコロン `:` を続けてヒューマンリーダブルなラベルをつけることができます。たとえば、`3050992291545088000:Clyde` のようになります。ラベルに空白を含めることはできますが、カンマを含めることはできません。また、コロンとそれ以降のラベルは無視されるため、ロールの名前と一致する必要はありません。

ロール ID を調べるには、Discord のユーザー設定で開発者モードを有効にする必要があります。

### ニックネームの構文

ニックネーム欄には、フォーマット指定子を含む文字列を入力します。フォーマット指定子は、ニックネームの形式を表すために使用され、ニックネームの適用時にユーザーの属性情報で置換される、% 記号から始まる 2 文字の文字列です。利用できるフォーマット指定子と、その置換対象との対応は次のとおりです。大文字小文字の差異は区別されます。最初にアスタリスク `*` がついているものは、ユーザーの種別が `0`（生徒）のときにのみ適用され、それ以外の場合は空文字列で置換されます。

|      |                            |
| :--: | :------------------------- |
| `%g` | \* 学年 (1, 2, 3, 4, 5, 6) |
| `%C` | \* 回生                    |
| `%c` | \* クラス                  |
| `%n` | \* 出席番号                |
| `%l` | 姓                         |
| `%f` | 名                         |
| `%%` | % 記号のエスケープ         |

ニックネームは、[Discord の仕様による制限](https://discord.com/developers/docs/resources/user#usernames-and-nicknames)を受けます。

### 適用のストラテジー

ロール適用のストラテジーは貪欲です。最初の行から順にマッチを調べ、一致したものすべてを適用します。一方、ニックネーム適用のストラテジーは怠惰です。最初の行から順にマッチを調べ、一番最初にマッチしたもののみ適用されます。これは、複数のニックネームを付与することができないためです。

### ファイルの扱いについて

- _ファイルを移動したり、名前を変更したりしてよいですか？_

    はい。あなたが所有権を持ち、適切な権限を与えている限り、アプリはファイルにアクセスできます。

- _新しいシートを作成してよいですか？_

    はい。シート 1 の削除以外のシートタブ操作は自由に行えます。

- _シートの編集してよい部分はどこですか？_

    アプリが読み取るのは、列 A:I の 2 行目以降の各セルの値のみです。読み取られるセルであっても、書式は自由に編集できます。それ以外のセルの値や書式について制限はありません。

## 記録されるログ

ログが記録される場合には、次のようなものがあります。

- ユーザーアカウントが学内のものと確認できなかった場合
- ユーザーが入力したプロフィール情報が Google アカウントから読み取ったプロフィール情報と合致しなかった場合
- スプレッドシートの内容の一部または全部を読み取るのに失敗した場合

    これには、資格情報の問題、ファイルアクセスの問題、構文エラーなどが含まれます。

- ニックネームの変更やロールの割り当てに失敗した場合
- 認証が完了し、プロフィール情報を記録する

## トラブルシューティング

- Missing Permissions というエラーが出てロールを付与できない

    Bot のロールが対象のロールよりも下に配置されている可能性があります。Discord サーバーのロールリストで順番を並べ替えてみてください。

- Missing Permissions というエラーが出てニックネームを変更できない

    対象者がサーバー所有者である場合、Discord の仕様上ニックネームを変更することはできません。

- Webhook を更新できない

    Discord サーバーの サーバー設定 > 連携サービス > nada-auth に該当の Webhook が存在する場合、それを削除してみてください。
